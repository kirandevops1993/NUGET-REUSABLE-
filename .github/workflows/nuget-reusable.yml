name: NuGet Reusable Workflow

on:
  workflow_call:
    inputs:
      solution:
        required: true
        type: string
      nugetConfigPath:
        required: true
        type: string
      restoreMode:
        required: true
        type: string
      noCache:
        required: true
        type: boolean
      nuGetRestoreArgs:
        required: true
        type: string
      verbosity:
        required: true
        type: string
      nuGetVersion:
        required: true
        type: string
      nuGetPath:
        required: true
        type: string

      selectorConfig:
        required: true
        type: string
      feed:
        required: true
        type: string
      includeNuGetOrg:
        required: true
        type: boolean
      packagesDirectory:
        required: true
        type: string

      searchPattern:
        required: true
        type: string
      outputdir:
        required: true
        type: string
      includeReferencedProjects:
        required: true
        type: boolean
      versionByBuild:
        required: true
        type: boolean
      versionEnvVar:
        required: true
        type: string
      requestedMajorVersion:
        required: true
        type: string
      requestedMinorVersion:
        required: true
        type: string
      requestedPatchVersion:
        required: true
        type: string
      configurationToPack:
        required: true
        type: string
      buildProperties:
        required: true
        type: string
      nuGetAdditionalArgs:
        required: true
        type: string

      nuGetFeedType:
        required: true
        type: string
      connectedServiceName:
        required: true
        type: string
      feedName:
        required: true
        type: string
      continueOnEmptyNupkgMatch:
        required: true
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download NuGet CLI
        run: |
          curl -L -o nuget.exe https://dist.nuget.org/win-x86-commandline/latest/nuget.exe

      - name: Restore NuGet Packages
        run: |
          ./nuget.exe restore "${{ inputs.solution }}" ^
            -ConfigFile "${{ inputs.nugetConfigPath }}" ^
            -PackagesDirectory "${{ inputs.packagesDirectory }}" ^
            -Verbosity "${{ inputs.verbosity }}" ^
            -NoHttpCache

      - name: Pack NuGet Package
        run: |
          ./nuget.exe pack "${{ inputs.searchPattern }}" ^
            -OutputDirectory "${{ inputs.outputdir }}" ^
            -Properties "Configuration=${{ inputs.configurationToPack }};${{ inputs.buildProperties }}" ^
            -Version "${{ inputs.requestedMajorVersion }}.${{ inputs.requestedMinorVersion }}.${{ inputs.requestedPatchVersion }}" ^
            ${{ inputs.nuGetAdditionalArgs }}

      - name: Push NuGet Package
        run: |
          ./nuget.exe push "${{ inputs.outputdir }}\\*.nupkg" ^
            -Source "${{ inputs.feedName }}" ^
            -Verbosity "${{ inputs.verbosity }}" ^
            ${{ inputs.nuGetAdditionalArgs }}
