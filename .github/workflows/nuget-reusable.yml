name: reusable-nuget-workflow

on:
  workflow_call:
    inputs:
      solution:
        required: true
        type: string
      nugetConfigPath:
        required: true
        type: string
      packagesDirectory:
        required: true
        type: string
      verbosity:
        required: true
        type: string
      nuGetRestoreArgs:
        required: false
        type: string
      restoreMode:
        required: false
        type: string
      noCache:
        required: false
        type: boolean
      nuGetVersion:
        required: false
        type: string
      nuGetPath:
        required: false
        type: string

      # Packager
      searchPattern:
        required: true
        type: string
      outputdir:
        required: true
        type: string
      includeReferencedProjects:
        required: true
        type: boolean
      versionByBuild:
        required: false
        type: boolean
      versionEnvVar:
        required: false
        type: string
      requestedMajorVersion:
        required: false
        type: string
      requestedMinorVersion:
        required: false
        type: string
      requestedPatchVersion:
        required: false
        type: string
      configurationToPack:
        required: false
        type: string
      buildProperties:
        required: false
        type: string
      nuGetAdditionalArgs:
        required: false
        type: string

      # Publisher
      nuGetFeedType:
        required: true
        type: string
      connectedServiceName:
        required: true
        type: string
      feedName:
        required: true
        type: string
      continueOnEmptyNupkgMatch:
        required: false
        type: boolean

jobs:
  build-and-publish:
    runs-on: windows-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download NuGet CLI
        run: |
          Invoke-WebRequest https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile nuget.exe

      - name: NuGet Restore
        run: |
          ./nuget.exe restore "${{ inputs.solution }}" `
            -ConfigFile "${{ inputs.nugetConfigPath }}" `
            -PackagesDirectory "${{ inputs.packagesDirectory }}" `
            -Verbosity "${{ inputs.verbosity }}" `
            -NoHttpCache
        shell: pwsh

      - name: NuGet Pack
        run: |
          ./nuget.exe pack "${{ inputs.searchPattern }}" `
            -OutputDirectory "${{ inputs.outputdir }}" `
            -IncludeReferencedProjects ${{ inputs.includeReferencedProjects }} `
            -Version "${{ inputs.requestedMajorVersion }}.${{ inputs.requestedMinorVersion }}.${{ inputs.requestedPatchVersion }}" `
            -Properties "Configuration=${{ inputs.configurationToPack }};${{ inputs.buildProperties }}" `
            ${{ inputs.nuGetAdditionalArgs }}
        shell: pwsh

      - name: NuGet Push
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.NUGET_AUTH_TOKEN }}
        run: |
          ./nuget.exe push "${{ inputs.outputdir }}\*.nupkg" `
            -Source "${{ inputs.feedName }}" `
            -ApiKey $env:NUGET_AUTH_TOKEN `
            -Verbosity "${{ inputs.verbosity }}" `
            ${{ inputs.nuGetAdditionalArgs }}
        shell: pwsh
