name: Reusable Workflow

on:
  workflow_call:
    inputs:
      solution:
        required: true
        type: string
      nugetConfigPath:
        required: true
        type: string
      restoreMode:
        required: true
        type: string
      noCache:
        required: true
        type: boolean
      nuGetRestoreArgs:
        required: true
        type: string
      verbosity:
        required: true
        type: string
      nuGetVersion:
        required: true
        type: string
      nuGetPath:
        required: true
        type: string
      searchPattern:
        required: true
        type: string
      outputdir:
        required: true
        type: string
      includeReferencedProjects:
        required: true
        type: string
      versionByBuild:
        required: true
        type: boolean
      versionEnvVar:
        required: true
        type: string
      requestedMajorVersion:
        required: true
        type: string
      requestedMinorVersion:
        required: true
        type: string
      requestedPatchVersion:
        required: true
        type: string
      configurationToPack:
        required: true
        type: string
      buildProperties:
        required: true
        type: string
      nuGetAdditionalArgs:
        required: true
        type: string
      nuGetFeedType:
        required: true
        type: string
      connectedServiceName:
        required: true
        type: string
      feedName:
        required: true
        type: string
      continueOnEmptyNupkgMatch:
        required: true
        type: string

jobs:
  nuget-installer:
    runs-on: ubuntu-latest
    steps:
      - name: Install NuGet Tool
        run: | 
          curl -o nuget.exe https://dist.nuget.org/win-x86-commandline/v${{ inputs.nuGetVersion }}/nuget.exe
          mkdir -p ${{ inputs.nuGetPath }}
          mv nuget.exe ${{ inputs.nuGetPath }}
        env:
          nuGetVersion: ${{ inputs.nuGetVersion }}

  nuget-restore:
    runs-on: ubuntu-latest
    needs: nuget-installer
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: NuGet Restore
        run: |
          ${{ inputs.nuGetPath }}/nuget restore ${{ inputs.solution }} -ConfigFile ${{ inputs.nugetConfigPath }}  
          -Verbosity ${{ inputs.verbosity }} ${{ inputs.nuGetRestoreArgs }}

  nuget-pack:
    runs-on: ubuntu-latest
    needs: nuget-restore
    steps:
      - name: NuGet Packager
        run: |
          ${{ inputs.nuGetPath }}/nuget pack ${{ inputs.searchPattern }} -OutputDirectory ${{ inputs.outputdir }}  
          -Properties ${{ inputs.buildProperties }} -ConfigFile ${{ inputs.nugetConfigPath }}  
          ${{ inputs.nuGetAdditionalArgs }}

  nuget-publish:
    runs-on: ubuntu-latest
    needs: nuget-pack
    steps:
      - name: NuGet Publisher
        run: |
          ${{ inputs.nuGetPath }}/nuget push ${{ inputs.outputdir }}/*.nupkg -Source ${{ inputs.feedName }}  
          -ApiKey ${{ inputs. connectedServiceName }} ${{ inputs.nuGetAdditionalArgs }}
