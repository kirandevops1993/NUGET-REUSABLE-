name: Reusable Dotnet Workflow

on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
      projects:
        required: false
        type: string
      arguments:
        required: false
        type: string
      nugetConfigPath:
        required: false
        type: string
      packagesToPack:
        required: false
        type: string
      configuration:
        required: true
        type: string
      custom:
        required: true
        type: boolean
      restoreArguments:
        required: false
        type: string
      testRunTitle:
        required: false
        type: string
      modifyOutputPath:
        required: true
        type: boolean
      packDirectory:
        required: true
        type: string
      nobuild:
        required: true
        type: boolean
      includesymbols:
        required: true
        type: boolean
      includesource:
        required: true
        type: boolean
      requestTimeout:
        required: false
        type: string
      noCache:
        required: true
        type: boolean
      restoreDirectory:
        required: true
        type: string
      verbosityRestore:
        required: true
        type: string
      sensitiveAlphanumericInfo1:
        required: true
        type: string
      versioningScheme:
        required: false
        type: string
      versionEnvVar:
        required: true
        type: string
      majorVersion:
        required: true
        type: string
      minorVersion:
        required: true
        type: string
      patchVersion:
        required: true
        type: string
      buildProperties:
        required: true
        type: string
      verbosityPack:
        required: true
        type: string
      workingDirectory:
        required: true
        type: string

jobs:
  dotnet:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ${{ inputs.workingDirectory }}

    env:
      VERSION: ${{ inputs.majorVersion }}.${{ inputs.minorVersion }}.${{ inputs.patchVersion }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.201'

      - name: Set version env var
        shell: bash
        run: echo "${{ inputs.versionEnvVar }}=$VERSION" >> $GITHUB_ENV

      - name: Execute dotnet ${{ inputs.command }}
        shell: bash
        run: |
          if [[ "${{ inputs.command }}" == "restore" ]]; then
            for proj in $(find . -name "*.csproj"); do
              dotnet restore "$proj" \
                $(if [[ -n "${{ inputs.nugetConfigPath }}" ]]; then echo "--configfile '${{ inputs.nugetConfigPath }}'"; fi) \
                ${{ inputs.restoreArguments }} \
                $(if [[ "${{ inputs.noCache }}" == "true" ]]; then echo "--no-cache"; fi) \
                --packages "${{ inputs.restoreDirectory }}" \
                --verbosity "${{ inputs.verbosityRestore }}"
            done

          elif [[ "${{ inputs.command }}" == "build" ]]; then
            for proj in $(find . -name "*.csproj"); do
              dotnet build "$proj" ${{ inputs.arguments }}
            done

          elif [[ "${{ inputs.command }}" == "test" ]]; then
            for proj in $(find . -name "*.csproj"); do
              dotnet test "$proj" ${{ inputs.arguments }} \
                --logger "trx;LogFileName=${{ inputs.testRunTitle }}.trx"
            done

          elif [[ "${{ inputs.command }}" == "pack" ]]; then
            for proj in $(find . -name "*.csproj"); do
              dotnet pack "$proj" \
                --configuration "${{ inputs.configuration }}" \
                --output "${{ inputs.packDirectory }}" \
                --no-build="${{ inputs.nobuild }}" \
                --include-symbols="${{ inputs.includesymbols }}" \
                --include-source="${{ inputs.includesource }}" \
                --property "Version=$VERSION;SensitiveAlphanumericInfo3=${{ inputs.sensitiveAlphanumericInfo1 }};${{ inputs.buildProperties }}" \
                --verbosity "${{ inputs.verbosityPack }}"
            done
          fi
