name: Reusable Workflow

on:
  workflow_call:
    inputs:
      solution:
        required: true
        type: string
      nugetConfigPath:
        required: true
        type: string
      restoreMode:
        required: true
        type: string
      noCache:
        required: true
        type: boolean
      nuGetRestoreArgs:
        required: true
        type: string
      verbosity:
        required: true
        type: string
      nuGetVersion:
        required: true
        type: string
      nuGetPath:
        required: true
        type: string
      searchPattern:
        required: true
        type: string
      outputdir:
        required: true
        type: string
      versionByBuild:
        required: true
        type: boolean
      versionEnvVar:
        required: true
        type: string
      configurationToPack:
        required: true
        type: string
      buildProperties:
        required: true
        type: string
      nuGetAdditionalArgs:
        required: true
        type: string
      nuGetFeedType:
        required: true
        type: string
      feedName:
        required: true
        type: string

jobs:
  setup-mono:
    runs-on: ubuntu-latest
    steps:
      - name: Install Mono
        run: |
          sudo apt update
          sudo apt install -y mono-complete

  nuget-installer:
    runs-on: ubuntu-latest
    needs: setup-mono
    steps:
      - name: Install NuGet Tool
        run: |
          curl -o nuget.exe https://dist.nuget.org/win-x86-commandline/v${{ inputs.nuGetVersion }}/nuget.exe
          mkdir -p ${{ inputs.nuGetPath }}
          mv nuget.exe ${{ inputs.nuGetPath }}/nuget.exe
        env:
          nuGetVersion: ${{ inputs.nuGetVersion }}

  nuget-restore:
    runs-on: ubuntu-latest
    needs: [setup-mono, nuget-installer]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: NuGet Restore
        run: |
          mono ${{ inputs.nuGetPath }}/nuget.exe restore ${{ inputs.solution }} -ConfigFile ${{ inputs.nugetConfigPath }}  
          -Verbosity ${{ inputs.verbosity }} ${{ inputs.nuGetRestoreArgs }}

  nuget-pack:
    runs-on: ubuntu-latest
    needs: nuget-restore
    steps:
      - name: NuGet Packager
        run: |
          mono ${{ inputs.nuGetPath }}/nuget.exe pack ${{ inputs.searchPattern }} -OutputDirectory ${{ inputs.outputdir }}  
          -Properties ${{ inputs.buildProperties }} -ConfigFile ${{ inputs.nugetConfigPath }}  
          ${{ inputs.nuGetAdditionalArgs }}

  nuget-publish:
    runs-on: ubuntu-latest
    needs: nuget-pack
    steps:
      - name: NuGet Publisher
        run: |
          mono ${{ inputs.nuGetPath }}/nuget.exe push ${{ inputs.outputdir }}/*.nupkg -Source ${{ inputs.feedName }}  
          ${{ inputs.nuGetAdditionalArgs }}
